<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aplikasi Todo List</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    /* Gaya untuk todo item */
    .todo-item.done {
      text-decoration: line-through;
      color: gray;
    }
    .todo-item {
      cursor: grab;
    }
    .drag-over {
      border: 2px dashed #0d6efd;
    }
  </style>
</head>
<body class="container py-4">
  <h1 class="mb-3">Todo List</h1>

  <!-- Form tambah todo -->
  <div class="input-group mb-3">
    <input type="text" id="todoInput" class="form-control" placeholder="Masukkan judul todo">
    <button id="addBtn" class="btn btn-primary">Tambah</button>
  </div>

  <!-- Filter & Pencarian -->
  <div class="d-flex mb-3 gap-2">
    <select id="filterSelect" class="form-select w-auto">
      <option value="all">Semua</option>
      <option value="done">Selesai</option>
      <option value="not-done">Belum Selesai</option>
    </select>
    <input type="text" id="searchInput" class="form-control" placeholder="Cari todo...">
  </div>

  <!-- Daftar todo -->
  <ul id="todoList" class="list-group"></ul>

  <script>
    // ===============================
    // Variabel Global
    // ===============================
    let todos = JSON.parse(localStorage.getItem("todos")) || [];

    // Referensi elemen DOM
    const todoInput = document.getElementById("todoInput");
    const addBtn = document.getElementById("addBtn");
    const todoList = document.getElementById("todoList");
    const filterSelect = document.getElementById("filterSelect");
    const searchInput = document.getElementById("searchInput");

    // ===============================
    // Fungsi Utilitas
    // ===============================

    // Simpan todos ke localStorage
    function saveTodos() {
      localStorage.setItem("todos", JSON.stringify(todos));
    }

    // Validasi input judul todo
    function isValidTitle(title, excludeIndex = -1) {
      if (!title || title.trim() === "") {
        alert("Judul tidak boleh kosong!");
        return false;
      }
      // Cek duplikasi (case-insensitive), kecuali index tertentu (saat edit)
      const duplicate = todos.some((t, i) => 
        t.title.toLowerCase() === title.toLowerCase() && i !== excludeIndex
      );
      if (duplicate) {
        alert("Judul todo sudah ada!");
        return false;
      }
      return true;
    }

    // ===============================
    // Fungsi CRUD
    // ===============================

    // Tambah todo baru
    function addTodo(title) {
      if (!isValidTitle(title)) return;
      todos.push({ title: title.trim(), done: false });
      saveTodos();
      renderTodos();
      todoInput.value = "";
    }

    // Edit todo
    function editTodo(index) {
      const newTitle = prompt("Edit judul todo:", todos[index].title);
      if (newTitle && isValidTitle(newTitle, index)) {
        todos[index].title = newTitle.trim();
        saveTodos();
        renderTodos();
      }
    }

    // Hapus todo
    function deleteTodo(index) {
      todos.splice(index, 1);
      saveTodos();
      renderTodos();
    }

    // Toggle status selesai/belum
    function toggleTodo(index) {
      todos[index].done = !todos[index].done;
      saveTodos();
      renderTodos();
    }

    // ===============================
    // Fungsi Render
    // ===============================

    function renderTodos() {
      todoList.innerHTML = "";

      const filter = filterSelect.value;
      const search = searchInput.value.toLowerCase();

      todos.forEach((todo, index) => {
        // Terapkan filter
        if (filter === "done" && !todo.done) return;
        if (filter === "not-done" && todo.done) return;
        if (!todo.title.toLowerCase().includes(search)) return;

        const li = createTodoElement(todo, index);
        todoList.appendChild(li);
      });
    }

    // Buat elemen todo
    function createTodoElement(todo, index) {
      const li = document.createElement("li");
      li.className = `list-group-item d-flex justify-content-between align-items-center todo-item ${todo.done ? "done" : ""}`;
      li.draggable = true;

      // Isi konten
      li.innerHTML = `
        <span>${todo.title}</span>
        <div>
          <button class="btn btn-sm btn-success me-1 toggleBtn">${todo.done ? "Belum" : "Selesai"}</button>
          <button class="btn btn-sm btn-warning me-1 editBtn">Edit</button>
          <button class="btn btn-sm btn-danger deleteBtn">Hapus</button>
        </div>
      `;

      // Event listener tombol
      li.querySelector(".toggleBtn").addEventListener("click", () => toggleTodo(index));
      li.querySelector(".editBtn").addEventListener("click", () => editTodo(index));
      li.querySelector(".deleteBtn").addEventListener("click", () => deleteTodo(index));

      // Event drag and drop
      addDragAndDropEvents(li, index);

      return li;
    }

    // ===============================
    // Fungsi Drag & Drop
    // ===============================
    function addDragAndDropEvents(li, index) {
      li.addEventListener("dragstart", (e) => {
        e.dataTransfer.setData("index", index);
      });

      li.addEventListener("dragover", (e) => {
        e.preventDefault();
        li.classList.add("drag-over");
      });

      li.addEventListener("dragleave", () => {
        li.classList.remove("drag-over");
      });

      li.addEventListener("drop", (e) => {
        e.preventDefault();
        li.classList.remove("drag-over");

        const fromIndex = parseInt(e.dataTransfer.getData("index"), 10);
        const toIndex = index;

        if (fromIndex === toIndex) return;

        const [movedItem] = todos.splice(fromIndex, 1);
        todos.splice(toIndex, 0, movedItem);

        saveTodos();
        renderTodos();
      });
    }

    // ===============================
    // Event Binding
    // ===============================
    addBtn.addEventListener("click", () => addTodo(todoInput.value));
    filterSelect.addEventListener("change", renderTodos);
    searchInput.addEventListener("input", renderTodos);

    // Tekan Enter pada input untuk tambah todo
    todoInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") addTodo(todoInput.value);
    });

    // ===============================
    // Inisialisasi Awal
    // ===============================
    renderTodos();
  </script>
</body>
</html>
